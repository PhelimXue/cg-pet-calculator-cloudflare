<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”åŠ›å¯¶è² - æ°¸æ†åˆå¿ƒ - å¯µç‰©æª”æ¬¡è¨ˆç®—æ©Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ OpenCC ç¹ç°¡è½‰æ›åº« -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .result-group {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #0d6efd;
        }
        .group-header {
            cursor: pointer;
            user-select: none;
        }
        .group-header:hover {
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .expand-icon {
            transition: transform 0.3s;
            display: inline-block;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        .random-combos {
            display: none;
            margin-top: 10px;
        }
        .random-combos.show {
            display: block;
        }
        .stat-badge {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .combo-item {
            padding: 10px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .percentage {
            font-weight: bold;
            color: #0d6efd;
            font-size: 1.1em;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error-message {
            display: none;
            margin: 20px 0;
        }
        .summary-stats {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 {
            color: #0d6efd;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        label {
            font-weight: 500;
            color: #495057;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        #search-results-container {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é­”åŠ›å¯¶è² - æ°¸æ†åˆå¿ƒ - å¯µç‰©æª”æ¬¡è¨ˆç®—æ©Ÿ</h1>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">è¼¸å…¥åƒæ•¸</h5>
                
                <!-- å¯µç‰©æœå°‹å€å¡Š -->
                <div class="mb-4 p-3 bg-light rounded border">
                    <label for="petSearch" class="form-label text-primary fw-bold">ğŸ” å¿«é€Ÿæœå°‹å¯µç‰© (å¡«å…¥æˆé•·æª”)</label>
                    <div class="position-relative">
                        <input type="text" class="form-control" id="petSearch" placeholder="è¼¸å…¥å¯µç‰©åç¨±æœå°‹ (ä¾‹å¦‚: è™äºº)..." autocomplete="off">
                        <div id="search-results-container" class="list-group"></div>
                    </div>
                </div>

                <form id="calculatorForm">
                    <!-- ç¬¬ä¸€è¡Œï¼šæˆé•·æª”(å·¦) | æˆé•·ç‡ | èª¤å·® -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="baseGrow" class="form-label">å¯µç‰©æˆé•·æª” (é«” æ”» å¼· æ• é­”)</label>
                            <input type="text" class="form-control" id="baseGrow" placeholder="ä¾‹å¦‚: 36 38 34 11 6" required>
                            <small class="form-text text-muted">æ ¼å¼ï¼šäº”å€‹æ•¸å­—ï¼Œç”¨ç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”</small>
                        </div>
                        <div class="col-md-3">
                            <label for="bpRateVal" class="form-label">æˆé•·ç‡ (%)</label>
                            <input type="number" class="form-control" id="bpRateVal" value="20" min="1" max="100" required>
                        </div>
                        <div class="col-md-3">
                            <label for="errorTolerance" class="form-label">å…è¨±èª¤å·®</label>
                            <select class="form-select" id="errorTolerance" required>
                                <option value="-1" selected>æ™ºèƒ½</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œï¼šç­‰ç´š | é»æ•¸ | ç´ è³ª(å³) -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="petLevel" class="form-label">å¯µç‰©ç­‰ç´š</label>
                            <input type="number" class="form-control" id="petLevel" value="1" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="remainingPoints" class="form-label">å‰©é¤˜é»æ•¸</label>
                            <input type="number" class="form-control" id="remainingPoints" value="0" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="targetStats" class="form-label">å¯µç‰©ç´ è³ª (è¡€ é­” æ”» é˜² æ•)</label>
                            <input type="text" class="form-control" id="targetStats" placeholder="ä¾‹å¦‚: 1797 683 348 355 132" required>
                            <small class="form-text text-muted">æ ¼å¼ï¼šäº”å€‹æ•¸å­—ï¼Œç”¨ç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">é–‹å§‹è¨ˆç®—</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­æç¤º -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">è¨ˆç®—ä¸­...</span>
            </div>
            <p class="mt-2">æ­£åœ¨è¨ˆç®—ä¸­ï¼Œè«‹ç¨å€™...</p>
            <p class="mt-2">è‹¥ä¸€ç›´å¡åœ¨é€™ï¼Œè«‹æª¢å¯Ÿæ˜¯å¦æœ‰ç©¿å¯µè£å°è‡´è¨ˆç®—ä¸å‡ºçµæœ...</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div class="alert alert-danger error-message" id="errorMessage"></div>

        <!-- çµæœé¡¯ç¤º -->
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { smartReverseCalculateMatrix } from './js/logic.js';

        const ATTR_NAMES = ['é«”åŠ›', 'åŠ›é‡', 'å¼·åº¦', 'é€Ÿåº¦', 'é­”æ³•'];
        const STAT_NAMES = { hp: 'HP', mp: 'MP', atk: 'ATK', def: 'DEF', agi: 'AGI' };

        // === å¯µç‰©è³‡æ–™èˆ‡æœå°‹ ===
        let petData = [];

        async function initPetData() {
            try {
                // 1. åˆå§‹åŒ– OpenCC è½‰æ›å™¨ (ç¹é«” -> ç°¡é«”)
                // é€™æ¨£æˆ‘å€‘å¯ä»¥æŠŠæ‰€æœ‰å¯µç‰©åå­—å¤šå­˜ä¸€ä»½ç°¡é«”ç‰ˆæœ¬ï¼Œæ–¹ä¾¿æ¯”å°
                let converter = null;
                if (window.OpenCC) {
                    converter = await window.OpenCC.Converter({ from: 'tw', to: 'cn' });
                }

                // 2. è¼‰å…¥è³‡æ–™
                const response = await fetch('./originmood-pet-data.json');
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥å¯µç‰©è³‡æ–™æª”');
                const json = await response.json();
                
                // 3. è™•ç†è³‡æ–™èˆ‡å»ºç«‹ç´¢å¼•
                petData = Object.entries(json).map(([key, value]) => {
                    const simpleName = converter ? converter(key) : key; // ç”¢ç”Ÿç°¡é«”å
                    return {
                        name: key,             // åŸå (å¦‚: è²“å¦–)
                        searchKey: simpleName, // æœå°‹ç”¨ç°¡é«”å (å¦‚: çŒ«å¦–)
                        grow: value.grow
                    };
                });
                
                console.log(`æˆåŠŸè¼‰å…¥ ${petData.length} ç­†å¯µç‰©è³‡æ–™ (åŒ…å«ç¹ç°¡ç´¢å¼•)`);

            } catch (err) {
                console.error('å¯µç‰©è³‡æ–™è¼‰å…¥å¤±æ•—:', err);
            }
        }
        initPetData();

        const searchInput = document.getElementById('petSearch');
        const resultsContainer = document.getElementById('search-results-container');
        const baseGrowInput = document.getElementById('baseGrow');

        // æœå°‹é‚è¼¯ä¿®æ”¹
        searchInput.addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            resultsContainer.innerHTML = '';
            
            if (term.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            // å¯¦ä½œç¹ç°¡é€šæœé‚è¼¯ï¼š
            // æˆ‘å€‘ä¸éœ€è¦æŠŠä½¿ç”¨è€…è¼¸å…¥è½‰ä¾†è½‰å»ï¼Œç›´æ¥é›™å‘æ¯”å°å³å¯ï¼š
            // å¦‚æœ ä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯ "çŒ«" (ç°¡)ï¼ŒæœƒåŒ¹é…åˆ° searchKey
            // å¦‚æœ ä½¿ç”¨è€…è¼¸å…¥çš„æ˜¯ "è²“" (ç¹)ï¼ŒæœƒåŒ¹é…åˆ° name
            const matches = petData.filter(pet => {
                return pet.name.includes(term) || pet.searchKey.includes(term);
            });

            if (matches.length > 0) {
                matches.forEach(pet => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action suggestion-item';
                    
                    // åœ¨åˆ—è¡¨é¡¯ç¤ºæ™‚ï¼Œå¯ä»¥æ¨™ç¤ºå‡ºåŸå§‹åç¨±
                    item.innerHTML = `<strong>${pet.name}</strong> <small class="text-muted">(${pet.grow})</small>`;
                    
                    item.addEventListener('click', () => {
                        baseGrowInput.value = pet.grow.replace(/,/g, ' ');
                        searchInput.value = pet.name; // é»æ“Šå¾Œï¼Œè¼¸å…¥æ¡†ä¸€å¾‹é¡¯ç¤ºæ­£ç¢ºçš„ç¹é«”åŸå
                        resultsContainer.style.display = 'none';
                        baseGrowInput.focus();
                        
                        // è¦–è¦ºå›é¥‹
                        baseGrowInput.style.backgroundColor = '#e7f3ff';
                        setTimeout(() => baseGrowInput.style.backgroundColor = '', 500);
                    });
                    
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== searchInput && e.target !== resultsContainer) {
                resultsContainer.style.display = 'none';
            }
        });

        // === è¨ˆç®—é‚è¼¯éƒ¨åˆ† (ç„¡è®Šæ›´) ===

        function parseNumberArray(input) {
            return input.trim()
                .replace(/,/g, ' ')
                .split(/\s+/)
                .map(n => parseFloat(n.trim()))
                .filter(n => !isNaN(n));
        }

        document.getElementById('calculatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            document.getElementById('results').innerHTML = '';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            setTimeout(async () => {
                try {
                    const baseGrow = parseNumberArray(document.getElementById('baseGrow').value);
                    const targetStatsArray = parseNumberArray(document.getElementById('targetStats').value);
                    const bpRateVal = parseInt(document.getElementById('bpRateVal').value);
                    const petLevel = parseInt(document.getElementById('petLevel').value);
                    const remainingPoints = parseInt(document.getElementById('remainingPoints').value);
                    const errorTolerance = parseInt(document.getElementById('errorTolerance').value);

                    if (baseGrow.length !== 5) throw new Error('å¯µç‰©æˆé•·æª”å¿…é ˆåŒ…å« 5 å€‹æ•¸å€¼');
                    if (targetStatsArray.length !== 5) throw new Error('å¯µç‰©ç´ è³ªå¿…é ˆåŒ…å« 5 å€‹æ•¸å€¼');

                    const targetStats = {
                        hp: targetStatsArray[0],
                        mp: targetStatsArray[1],
                        atk: targetStatsArray[2],
                        def: targetStatsArray[3],
                        agi: targetStatsArray[4]
                    };

                    const result = await smartReverseCalculateMatrix(
                        baseGrow,
                        targetStats,
                        petLevel,
                        bpRateVal / 100,
                        0,
                        remainingPoints,
                        errorTolerance
                    );

                    const data = result.results;
                    const summary = {
                        totalMatches: result.results.length,
                        executionTime: result.executionTime,
                        totalCombinationsTested: result.totalCombinationsTested
                    };

                    displayResults(data, summary, baseGrow);

                } catch (error) {
                    showError(error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }, 50);
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayResults(data, summary, baseGrow) {
            if (data.length === 0) {
                document.getElementById('results').innerHTML = `
                    <div class="alert alert-warning">
                        <strong>æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„åˆ</strong>
                        <p class="mb-0">è«‹å˜—è©¦èª¿æ•´åƒæ•¸æˆ–å¢åŠ å…è¨±èª¤å·®å€¼ã€‚</p>
                    </div>
                `;
                return;
            }

            const groupedResults = groupByDropAndManual(data);
            const dropStats = calculateDropStats(data, baseGrow);

            let html = `
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">è¨ˆç®—çµæœ</h5>

                        <div class="summary-stats">
                            <h6>æ‰¾åˆ° ${summary.totalMatches} å€‹æœ€å°èª¤å·®çš„çµ„åˆï¼ˆç¸½èª¤å·® ${data[0].totalError}ï¼‰</h6>
                            <p class="mb-2"><strong>åŸ·è¡Œæ™‚é–“ï¼š</strong>${summary.executionTime} ç§’</p>
                            <p class="mb-0"><strong>æ¸¬è©¦æ‰æª”çµ„åˆæ•¸ï¼š</strong>${summary.totalCombinationsTested.toLocaleString()}</p>
                        </div>

                        <div class="alert alert-info">
                            <h6 class="alert-heading">æ‰æª”çµ±è¨ˆ</h6>
                            <p class="mb-2"><strong>ç¸½æ‰æª”è½åœ¨ ${dropStats.totalDropRange.min}-${dropStats.totalDropRange.max} æª”</strong></p>
                            <p class="mb-0">å„å±¬æ€§ï¼š${dropStats.attributeRanges.join('ã€')}</p>
                        </div>

                        <h6 class="mt-4 mb-3">æ‰¾åˆ° ${Object.keys(groupedResults).length} å€‹ç¬¦åˆæ¢ä»¶çš„çµ„åˆ</h6>
                        ${renderGroupedResults(groupedResults, data.length)}
                    </div>
                </div>
            `;

            document.getElementById('results').innerHTML = html;
        }

        function groupByDropAndManual(data) {
            const groups = {};
            data.forEach(item => {
                const key = item.dropCombo.join(',') + '|' + item.manualPoints.join(',');
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
            });
            return groups;
        }

        function calculateDropStats(data, baseGrow) {
            let totalDropMin = Infinity;
            let totalDropMax = -Infinity;
            const attrDropRanges = Array(5).fill().map(() => ({ min: Infinity, max: -Infinity }));

            data.forEach(item => {
                const totalDrop = item.dropCombo.reduce((sum, d) => sum + d, 0);
                totalDropMin = Math.min(totalDropMin, totalDrop);
                totalDropMax = Math.max(totalDropMax, totalDrop);

                item.dropCombo.forEach((drop, i) => {
                    attrDropRanges[i].min = Math.min(attrDropRanges[i].min, drop);
                    attrDropRanges[i].max = Math.max(attrDropRanges[i].max, drop);
                });
            });

            const attributeRanges = attrDropRanges.map((range, i) => {
                if (range.min === range.max) return `${ATTR_NAMES[i]}å¿…å®š-${range.min}`;
                else return `${ATTR_NAMES[i]}è½åœ¨-${range.max}åˆ°-${range.min}`;
            });

            return {
                totalDropRange: { min: totalDropMin, max: totalDropMax },
                attributeRanges: attributeRanges
            };
        }

        function renderGroupedResults(groupedResults, totalCount) {
            let html = '';
            let groupIndex = 0;
            const sortedGroups = Object.entries(groupedResults).sort((a, b) => b[1].length - a[1].length);

            sortedGroups.forEach(([groupKey, items]) => {
                const percentage = ((items.length / totalCount) * 100).toFixed(2);
                const [dropComboStr, manualPointsStr] = groupKey.split('|');
                const dropCombo = dropComboStr.split(',').map(n => parseInt(n));
                const manualPoints = manualPointsStr.split(',').map(n => parseInt(n));
                const manualPointsText = formatManualPoints(manualPoints);
                
                html += `
                    <div class="result-group">
                        <div class="group-header" onclick="document.dispatchEvent(new CustomEvent('toggle-group', {detail: ${groupIndex}}))">
                            <span class="expand-icon" id="icon-${groupIndex}">â–¶</span>
                            <span class="percentage">${percentage}%</span>
                            <div class="mt-2">
                                <strong>æ‰æª”ï¼š</strong>${dropCombo.map((d, i) => `${ATTR_NAMES[i]}${d}`).join(' ')}
                            </div>
                            <div class="mt-1">
                                <strong>åŠ é»ï¼š</strong>${manualPointsText}
                            </div>
                            <div class="mt-1 text-muted" style="font-size: 0.9em;">
                                <em>é»æ“Šå±•é–‹ ${items.length} å€‹éš¨æ©Ÿæª”çµ„åˆ</em>
                            </div>
                        </div>
                        <div class="random-combos" id="group-${groupIndex}">
                            ${items.map(item => renderRandomCombo(item)).join('')}
                        </div>
                    </div>
                `;
                groupIndex++;
            });
            return html;
        }

        // ä½¿ç”¨ CustomEvent ä¾†è™•ç† onclick (æ›´ä¹¾æ·¨çš„å¯«æ³•)
        document.addEventListener('toggle-group', (e) => {
            toggleGroup(e.detail);
        });

        function toggleGroup(index) {
            const group = document.getElementById(`group-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            if (group.classList.contains('show')) {
                group.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                group.classList.add('show');
                icon.classList.add('expanded');
            }
        }

        function renderRandomCombo(item) {
            return `
                <div class="combo-item">
                    <div><strong>éš¨æ©Ÿæª”ï¼š</strong>${item.randomCombo.map((r, i) => `${ATTR_NAMES[i]}${r}`).join(' ')}</div>
                    <div class="mt-1">
                        <span class="stat-badge">HP: ${item.stats.hp.toFixed(2)}</span>
                        <span class="stat-badge">MP: ${item.stats.mp.toFixed(2)}</span>
                        <span class="stat-badge">ATK: ${item.stats.atk.toFixed(2)}</span>
                        <span class="stat-badge">DEF: ${item.stats.def.toFixed(2)}</span>
                        <span class="stat-badge">AGI: ${item.stats.agi.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function formatManualPoints(points) {
            const nonZero = points.map((p,i) => p > 0 ? `${ATTR_NAMES[i]}${p}é»` : null).filter(p => p);
            return nonZero.length > 0 ? nonZero.join('ï¼Œ') : 'ç„¡åŠ é»';
        }
    </script>
</body>
</html>