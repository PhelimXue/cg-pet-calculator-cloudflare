<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”åŠ›å¯¶è² - æ°¸æ†åˆå¿ƒ - å¯µç‰©æª”æ¬¡è¨ˆç®—æ©Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ OpenCC ç¹ç°¡è½‰æ›åº« -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .result-group {
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #0d6efd;
        }
        .group-header {
            cursor: pointer;
            user-select: none;
        }
        .group-header:hover {
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .expand-icon {
            transition: transform 0.3s;
            display: inline-block;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        .random-combos {
            display: none;
            margin-top: 10px;
        }
        .random-combos.show {
            display: block;
        }
        .stat-badge {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #e9ecef;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .combo-item {
            padding: 10px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .percentage {
            font-weight: bold;
            color: #0d6efd;
            font-size: 1.1em;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .error-message {
            display: none;
            margin: 20px 0;
        }
        .summary-stats {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h1 {
            color: #0d6efd;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        label {
            font-weight: 500;
            color: #495057;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        #search-results-container {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é­”åŠ›å¯¶è² - æ°¸æ†åˆå¿ƒ - å¯µç‰©æª”æ¬¡è¨ˆç®—æ©Ÿ</h1>

        <!-- è¼¸å…¥è¡¨å–® -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">è¼¸å…¥åƒæ•¸</h5>
                
                <!-- å¯µç‰©æœå°‹å€å¡Š -->
                <div class="mb-4 p-3 bg-light rounded border">
                    <label for="petSearch" class="form-label text-primary fw-bold">ğŸ” å¿«é€Ÿæœå°‹å¯µç‰©</label>
                    <div class="position-relative">
                        <input type="text" class="form-control" id="petSearch" placeholder="è¼¸å…¥å¯µç‰©åç¨±æœå°‹ (ä¾‹å¦‚: è™äºº)..." autocomplete="off">
                        <div id="search-results-container" class="list-group"></div>
                    </div>
                </div>

                <form id="calculatorForm">
                    <!-- ç¬¬ä¸€è¡Œï¼šæˆé•·æª”(å·¦) | æˆé•·ç‡ -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="baseGrow" class="form-label">å¯µç‰©æˆé•·æª” (é«” åŠ› å¼· é€Ÿ é­”)</label>
                            <input type="text" class="form-control" id="baseGrow" placeholder="ä¾‹å¦‚: 36 38 34 11 6" required>
                            <small class="form-text text-muted">æ ¼å¼ï¼šäº”å€‹æ•¸å­—ï¼Œç”¨ç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”</small>
                        </div>
                        <div class="col-md-4">
                            <label for="bpRateVal" class="form-label">æˆé•·ç‡ (%)</label>
                            <input type="number" class="form-control" id="bpRateVal" value="20" min="1" max="100" required>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œï¼šç­‰ç´š | é»æ•¸ | ç´ è³ª(å³) -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="petLevel" class="form-label">å¯µç‰©ç­‰ç´š</label>
                            <input type="number" class="form-control" id="petLevel" value="1" min="1" required>
                        </div>
                        <div class="col-md-3">
                            <label for="remainingPoints" class="form-label">å‰©é¤˜é»æ•¸</label>
                            <input type="number" class="form-control" id="remainingPoints" value="0" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label for="targetStats" class="form-label">å¯µç‰©ç´ è³ª (è¡€ é­” æ”» é˜² æ•)</label>
                            <input type="text" class="form-control" id="targetStats" placeholder="ä¾‹å¦‚: 1797 683 348 355 132" required>
                            <small class="form-text text-muted">æ ¼å¼ï¼šäº”å€‹æ•¸å­—ï¼Œç”¨ç©ºæ ¼æˆ–é€—è™Ÿåˆ†éš”</small>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">é–‹å§‹è¨ˆç®—</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­æç¤º -->
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">è¨ˆç®—ä¸­...</span>
            </div>
            <p class="mt-2 text-primary fw-bold">æ­£åœ¨è¨ˆç®—ä¸­ï¼Œè«‹ç¨å€™...</p>
            <!-- ä¸­æ–·æŒ‰éˆ• -->
            <button type="button" class="btn btn-danger mt-2" id="cancelBtn">
                â›” ä¸­æ–·è¨ˆç®—
            </button>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div class="alert alert-danger error-message" id="errorMessage"></div>

        <!-- çµæœé¡¯ç¤º -->
        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { smartReverseCalculateMatrix } from './js/logic.js';

        const ATTR_NAMES = ['é«”åŠ›', 'åŠ›é‡', 'å¼·åº¦', 'é€Ÿåº¦', 'é­”æ³•'];
        const STAT_NAMES = { hp: 'HP', mp: 'MP', atk: 'ATK', def: 'DEF', agi: 'AGI' };

        // === URL åƒæ•¸è™•ç† ===
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (!params.has('baseGrow')) return false; // æ²’æœ‰åƒæ•¸å°±ä¸è™•ç†

            // è¼‰å…¥åŸºæœ¬åƒæ•¸
            if (params.has('baseGrow')) document.getElementById('baseGrow').value = params.get('baseGrow');
            if (params.has('bpRateVal')) document.getElementById('bpRateVal').value = params.get('bpRateVal');
            if (params.has('petLevel')) document.getElementById('petLevel').value = params.get('petLevel');
            if (params.has('remainingPoints')) document.getElementById('remainingPoints').value = params.get('remainingPoints');
            if (params.has('targetStats')) document.getElementById('targetStats').value = params.get('targetStats');

            return true; // è¡¨ç¤ºæœ‰è¼‰å…¥åƒæ•¸
        }

        function generateShareURL() {
            const params = new URLSearchParams();

            // æ”¶é›†æ‰€æœ‰åƒæ•¸
            params.set('baseGrow', document.getElementById('baseGrow').value);
            params.set('bpRateVal', document.getElementById('bpRateVal').value);
            params.set('petLevel', document.getElementById('petLevel').value);
            params.set('remainingPoints', document.getElementById('remainingPoints').value);
            params.set('targetStats', document.getElementById('targetStats').value);

            // ä½¿ç”¨ç•¶å‰ domain
            const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            return url;
        }

        // å°‡ copyToClipboard è¨­ç‚ºå…¨åŸŸå‡½æ•¸ä¾› onclick ä½¿ç”¨
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
                const btn = document.getElementById('shareBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'âœ“ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-info');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-info');
                    btn.classList.add('btn-success');
                }, 2000);
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ URL');
            });
        };

        // === å¯µç‰©è³‡æ–™èˆ‡æœå°‹ ===
        let petData = [];
        let growToNameMap = {}; // æ–°å¢ï¼šæˆé•·æª”åˆ°åç¨±çš„åå‘ç´¢å¼•

        async function initPetData() {
            try {
                let converter = null;
                if (window.OpenCC) {
                    converter = await window.OpenCC.Converter({ from: 'tw', to: 'cn' });
                }

                const response = await fetch('./originmood-pet-data.json');
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥å¯µç‰©è³‡æ–™æª”');
                const json = await response.json();

                petData = Object.entries(json).map(([key, value]) => {
                    const simpleName = converter ? converter(key) : key;
                    
                    // --- å»ºç«‹åå‘ç´¢å¼•é‚è¼¯ ---
                    // å°‡æˆé•·æª”å­—ä¸²å»é™¤ç©ºæ ¼ï¼Œç¢ºä¿æ ¼å¼çµ±ä¸€ ("22,26..." æˆ– "22 26..." éƒ½å°æ‡‰åˆ°åŒä¸€å€‹ key)
                    // JSON åŸå§‹æ ¼å¼å‡è¨­ç‚ºé€—è™Ÿåˆ†éš” "22,26,17,19,16"
                    const rawGrow = value.grow;
                    // ç‚ºäº†æ–¹ä¾¿æ¯”å°ï¼Œçµ±ä¸€è½‰æˆ "æ•¸å­—,æ•¸å­—..." (å»é™¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼)
                    const normalizedGrowKey = rawGrow.replace(/\s+/g, '');

                    if (!growToNameMap[normalizedGrowKey]) {
                        growToNameMap[normalizedGrowKey] = [];
                    }
                    growToNameMap[normalizedGrowKey].push(key);
                    // ------------------------

                    return {
                        name: key,
                        searchKey: simpleName,
                        grow: value.grow
                    };
                });

                console.log(`æˆåŠŸè¼‰å…¥ ${petData.length} ç­†å¯µç‰©è³‡æ–™`);

            } catch (err) {
                console.error('å¯µç‰©è³‡æ–™è¼‰å…¥å¤±æ•—:', err);
                // å³ä¾¿å¤±æ•—ä¹Ÿä¸å½±éŸ¿ä¸»åŠŸèƒ½ï¼Œåªæ˜¯æœå°‹ä¸èƒ½ç”¨
            }
        }

        // åˆå§‹åŒ–æµç¨‹
        async function init() {
            await initPetData();

            // æª¢æŸ¥ä¸¦è¼‰å…¥ URL åƒæ•¸
            const hasParams = loadFromURL();
            if (hasParams) {
                // å¦‚æœæœ‰ URL åƒæ•¸ï¼Œè‡ªå‹•åŸ·è¡Œè¨ˆç®—
                console.log('å¾ URL è¼‰å…¥åƒæ•¸ï¼Œè‡ªå‹•é–‹å§‹è¨ˆç®—...');
                setTimeout(() => {
                    document.getElementById('calculatorForm').dispatchEvent(new Event('submit'));
                }, 100);
            }
        }

        init();

        const searchInput = document.getElementById('petSearch');
        const resultsContainer = document.getElementById('search-results-container');
        const baseGrowInput = document.getElementById('baseGrow');

        // === æ–°å¢ï¼šç›£è½ BaseGrow è¼¸å…¥è®Šå‹•ï¼Œåå‘å¡«å……å¯µç‰©åç¨± ===
        baseGrowInput.addEventListener('input', (e) => {
            const val = e.target.value;
            // è™•ç†ä½¿ç”¨è€…è¼¸å…¥ï¼šå»é™¤é ­å°¾ç©ºæ ¼ã€å°‡é€£çºŒç©ºæ ¼æˆ–å…¨/åŠå½¢é€—è™Ÿè½‰ç‚ºå–®ä¸€é€—è™Ÿï¼Œä»¥ä¾¿ç”¢ç”Ÿ Key
            // ä¾‹å¦‚ "22 26 17 19 16" -> "22,26,17,19,16"
            const lookupKey = val.trim()
                .split(/[\s,ï¼Œ]+/) // ä¾ç…§ç©ºç™½æˆ–é€—è™Ÿåˆ‡å‰²
                .join(',');        // é‡æ–°çµ„åˆæˆé€—è™Ÿåˆ†éš”å­—ä¸²
            
            // ç”±æ–¼ JSON Key æ˜¯ä¸å«ç©ºæ ¼çš„é€—è™Ÿåˆ†éš”å­—ä¸²
            if (growToNameMap[lookupKey]) {
                searchInput.value = growToNameMap[lookupKey].join(' / ');
                // è¦–è¦ºå›é¥‹
                searchInput.style.borderColor = "#198754"; // ç¶ è‰²é‚Šæ¡†è¡¨ç¤ºåŒ¹é…æˆåŠŸ
                setTimeout(() => searchInput.style.borderColor = "", 1000);
            }
        });
        // ==================================================

        searchInput.addEventListener('input', async (e) => {
            const term = e.target.value.trim();
            resultsContainer.innerHTML = '';
            
            if (term.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            const matches = petData.filter(pet => {
                return pet.name.includes(term) || pet.searchKey.includes(term);
            });

            if (matches.length > 0) {
                matches.forEach(pet => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action suggestion-item';
                    item.innerHTML = `<strong>${pet.name}</strong> <small class="text-muted">(${pet.grow})</small>`;
                    
                    item.addEventListener('click', () => {
                        baseGrowInput.value = pet.grow.replace(/,/g, ' ');
                        searchInput.value = pet.name;
                        resultsContainer.style.display = 'none';
                        baseGrowInput.focus();
                        
                        baseGrowInput.style.backgroundColor = '#e7f3ff';
                        setTimeout(() => baseGrowInput.style.backgroundColor = '', 500);
                    });
                    
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== searchInput && e.target !== resultsContainer) {
                resultsContainer.style.display = 'none';
            }
        });

        // === è¨ˆç®—é‚è¼¯éƒ¨åˆ† ===

        function parseNumberArray(input) {
            return input.trim()
                .replace(/,/g, ' ')
                .split(/\s+/)
                .map(n => parseFloat(n.trim()))
                .filter(n => !isNaN(n));
        }

        // ç”¨ä¾†å­˜æ”¾å½“å‰çš„ Controller (ç”¨æ–¼ä¸­æ–·)
        let abortController = null;

        document.getElementById('calculatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // å¦‚æœå·²æœ‰æ­£åœ¨è·‘çš„è¨ˆç®—ï¼Œå…ˆä¸­æ–·å®ƒ
            if (abortController) {
                abortController.abort();
            }
            // å»ºç«‹æ–°çš„ Controller
            abortController = new AbortController();

            document.getElementById('results').innerHTML = '';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            // è¨­å®šä¸­æ–·æŒ‰éˆ•äº‹ä»¶
            const cancelBtn = document.getElementById('cancelBtn');
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'â›” ä¸­æ–·è¨ˆç®—';
            cancelBtn.onclick = () => {
                if (abortController) {
                    abortController.abort(); // ç™¼é€ä¸­æ–·ä¿¡è™Ÿ
                    cancelBtn.textContent = 'æ­£åœ¨ä¸­æ­¢...';
                    cancelBtn.disabled = true;
                }
            };

            // ä½¿ç”¨ setTimeout ç¢ºä¿ UI (Loading) å·²ç¶“ç•«å‡ºä¾†
            setTimeout(async () => {
                try {
                    // åŸºæœ¬æª¢æŸ¥èˆ‡è®€å€¼ (é€™éƒ¨åˆ†å¾ˆå¿«ï¼Œä¸éœ€è¦ä¸­æ–·æ©Ÿåˆ¶)
                    const baseGrow = parseNumberArray(document.getElementById('baseGrow').value);
                    const targetStatsArray = parseNumberArray(document.getElementById('targetStats').value);
                    const bpRateVal = parseInt(document.getElementById('bpRateVal').value);
                    const petLevel = parseInt(document.getElementById('petLevel').value);
                    const remainingPoints = parseInt(document.getElementById('remainingPoints').value);

                    if (baseGrow.length !== 5) throw new Error('å¯µç‰©æˆé•·æª”å¿…é ˆåŒ…å« 5 å€‹æ•¸å€¼');
                    if (targetStatsArray.length !== 5) throw new Error('å¯µç‰©ç´ è³ªå¿…é ˆåŒ…å« 5 å€‹æ•¸å€¼');

                    const targetStats = {
                        hp: targetStatsArray[0],
                        mp: targetStatsArray[1],
                        atk: targetStatsArray[2],
                        def: targetStatsArray[3],
                        agi: targetStatsArray[4]
                    };

                    // === å–®ä¸€è¨ˆç®—æ¨¡å¼ ===
                    const result = await smartReverseCalculateMatrix(
                        baseGrow,
                        targetStats,
                        petLevel,
                        bpRateVal / 100,
                        0,
                        remainingPoints,
                        null,
                        abortController.signal
                    );

                    const data = result.results;
                    const summary = {
                        totalMatches: result.results.length,
                        executionTime: result.executionTime,
                        totalCombinationsTested: result.totalCombinationsTested
                    };

                    displayResults(data, summary, baseGrow);

                } catch (error) {
                    // å€åˆ†æ˜¯ã€Œæ‰‹å‹•ä¸­æ–·ã€é‚„æ˜¯ã€Œç¨‹å¼éŒ¯èª¤ã€
                    if (error.message === 'ABORTED' || error.name === 'AbortError') {
                        document.getElementById('results').innerHTML = `
                            <div class="alert alert-warning border border-warning">
                                <h4>ğŸ›‘ å·²ä¸­æ–·è¨ˆç®—</h4>
                                <p class="mb-0">æ‚¨å·²æ‰‹å‹•åœæ­¢é‹ç®—ã€‚è‹¥é‹ç®—éä¹…ï¼Œå»ºè­°æª¢æŸ¥è¼¸å…¥æ•¸å€¼æ˜¯å¦æ­£ç¢ºï¼ˆä¾‹å¦‚æ˜¯å¦å¿˜è¨˜è„«è£å‚™ï¼‰ã€‚</p>
                            </div>
                        `;
                    } else {
                        showError(error.message);
                        console.error(error);
                    }
                } finally {
                    document.getElementById('loading').style.display = 'none';
                    abortController = null; // æ¸…ç©º
                }
            }, 50);
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerText = message;
            errorDiv.style.display = 'block';
        }

        function displayResults(data, summary, baseGrow) {
            // ç”¢ç”Ÿåˆ†äº«æŒ‰éˆ•
            const shareURL = generateShareURL();
            const shareButtonHTML = `
                <div class="alert alert-success d-flex align-items-center justify-content-between">
                    <div>
                        <strong>ğŸ”— åˆ†äº«æ­¤æ¬¡è¨ˆç®—</strong>
                        <p class="mb-0 small text-muted">è¤‡è£½é€£çµåˆ†äº«çµ¦å…¶ä»–äººï¼Œä»–å€‘æ‰“é–‹é€£çµå¾Œæœƒè‡ªå‹•è¨ˆç®—ç›¸åŒçµæœ</p>
                    </div>
                    <button id="shareBtn" class="btn btn-success" onclick="copyToClipboard('${shareURL.replace(/'/g, "\\'")}')">
                        ğŸ“‹ è¤‡è£½åˆ†äº«é€£çµ
                    </button>
                </div>
            `;

            if (data.length === 0) {
                document.getElementById('results').innerHTML = `
                    ${shareButtonHTML}
                    <div class="alert alert-warning">
                        <strong>æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„çµ„åˆ</strong>
                        <p class="mb-0">è«‹å˜—è©¦èª¿æ•´åƒæ•¸ã€‚</p>
                    </div>
                `;
                return;
            }

            // === æ–°å¢ï¼šæ‡‰ç”¨æœ€ä½³é…é»ç­–ç•¥éæ¿¾ ===
            const originalCount = data.length;
            const filteredData = filterBestStrategies(data);
            const filteredCount = filteredData.length;
            // ===============================

            const groupedResults = groupByDropAndManual(filteredData);
            const dropStats = calculateDropStats(filteredData, baseGrow);

            // æç¤ºè¨Šæ¯ï¼šå¦‚æœéæ¿¾æ‰äº†æŸäº›çµæœï¼Œé¡¯ç¤ºæç¤º
            let filterMsg = '';
            if (filteredCount < originalCount) {
                filterMsg = `
                    <div class="alert alert-secondary border-start border-4 border-secondary">
                        <strong>âš¡ æ™ºèƒ½éæ¿¾å•Ÿç”¨</strong>
                        <br>
                        ç³»çµ±æ‰¾åˆ° ${originalCount} ç¨®å¯èƒ½ï¼Œå·²è‡ªå‹•éæ¿¾éä¸»æµé…é»ï¼ˆå¦‚é›œäº‚æ··é»ï¼‰ã€‚
                        <br>
                        ç›®å‰é¡¯ç¤º <strong>${filteredCount}</strong> ç¨®ç¬¦åˆã€Œé›†ä¸­é…é»ç­–ç•¥ã€çš„çµæœã€‚
                    </div>
                `;
            }

            let html = `
                ${shareButtonHTML}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">è¨ˆç®—çµæœ</h5>

                        <div class="summary-stats">
                            <h6>ç¬¦åˆæ¢ä»¶ï¼š${filteredCount} (åŸå§‹æœå°‹: ${originalCount})</h6>
                            <p class="mb-2"><strong>åŸ·è¡Œæ™‚é–“ï¼š</strong>${summary.executionTime} ç§’</p>
                            <p class="mb-0"><strong>æ¸¬è©¦çµ„åˆæ•¸ï¼š</strong>${summary.totalCombinationsTested.toLocaleString()}</p>
                        </div>

                        ${filterMsg}

                        <div class="alert alert-info">
                            <h6 class="alert-heading">æ‰æª”çµ±è¨ˆ (åŸºæ–¼é¡¯ç¤ºçµæœ)</h6>
                            <p class="mb-2"><strong>ç¸½æ‰æª”è½åœ¨ ${dropStats.totalDropRange.min}-${dropStats.totalDropRange.max} æª”</strong></p>
                            ${dropStats.certainDrops.length > 0
                                ? `<p class="mb-0">å„å±¬æ€§ï¼š${dropStats.certainDrops.join('ã€')}</p>`
                                : '<p class="mb-0 text-muted">å„å±¬æ€§æ‰æª”ä¸ç¢ºå®š</p>'}
                        </div>

                        <h6 class="mt-4 mb-3">é¡¯ç¤º ${Object.keys(groupedResults).length} çµ„çµæœ</h6>
                        ${renderGroupedResults(groupedResults, filteredCount)}
                    </div>
                </div>
            `;

            document.getElementById('results').innerHTML = html;
        }

        /**
         * æ™ºèƒ½éæ¿¾ç­–ç•¥ v4 (åŒç´šç²¾æº–åº¦å„ªå…ˆ)
         * 
         * é †åº 1ï¼šé…é»ç¨®é¡æ•¸ (Complexity) - é0é …ç›®è¶Šå°‘è¶Šå¥½ (å–®é…é» > é›™é…é» > ä¸‰é…é»)
         * é †åº 2ï¼šèª¤å·®ç¸½å€¼ (Accuracy) - åœ¨åŒæ¨£çš„é…é»ç¨®é¡ä¸‹ï¼Œèª¤å·®è¶Šå°è¶Šå¥½ (æ‚¨æåˆ°çš„ 19/63 èª¤å·®å¤§ vs 23/59 èª¤å·®å°)
         * é †åº 3ï¼šæ•¸å€¼é›†ä¸­åº¦ (Concentration) - åœ¨åŒæ¨£ç¨®é¡ä¸”åŒæ¨£èª¤å·®ä¸‹ï¼Œå–®é …æ•¸å€¼è¶Šé«˜è¶Šå¥½
         */
        function filterBestStrategies(results) {
            if (!results || results.length === 0) return [];

            // 1. è¨ˆç®—é…é»ç¨®é¡ (Complexity): ä¾‹å¦‚ [80,0,0,0,0] = 1, [40,40,0,0,0] = 2
            const getComplexity = (points) => points.filter(p => p > 0).length;

            // 2. è¨ˆç®—ç¸½çµ•å°èª¤å·® (Accuracy)
            const getTotalError = (row) => {
                // å¦‚æœæœ‰è©³ç´°èª¤å·® diffs ç‰©ä»¶ï¼ŒåŠ ç¸½çµ•å°å€¼
                if (row.diffs) {
                    return Math.abs(row.diffs.hp) + 
                           Math.abs(row.diffs.mp) + 
                           Math.abs(row.diffs.atk) + 
                           Math.abs(row.diffs.def) + 
                           Math.abs(row.diffs.agi);
                }
                // å‚™æ¡ˆï¼šä½¿ç”¨ç°¡æ˜“ç¸½å’Œ
                return Math.abs(row.sumDiff || 0);
            };

            // 3. å–å¾—é…é»ç‰¹å¾µ (ç”±å¤§åˆ°å°æ’åºï¼Œç”¨æ–¼æ¯”è¼ƒèª°çš„å–®é …æ•¸å€¼æ¯”è¼ƒé«˜)
            const getSignature = (row) => [...row.manualPoints].sort((a, b) => b - a);

            // === æ ¸å¿ƒæ’åºé‚è¼¯ ===
            const sortedResults = [...results].sort((a, b) => {
                
                // ç¬¬ä¸€é—œï¼šæ¯”é…é»ç¨®é¡ (è¶Šå°‘è¶Šå¥½)
                // å¦‚æœ A æ˜¯é›™é…é»(2)ï¼ŒB æ˜¯ä¸‰é…é»(3)ï¼ŒA æ’å‰é¢
                const compA = getComplexity(a.manualPoints);
                const compB = getComplexity(b.manualPoints);
                if (compA !== compB) return compA - compB;

                // ç¬¬äºŒé—œï¼šæ¯”èª¤å·® (è¶Šå°è¶Šå¥½)
                // åªæœ‰åœ¨ã€Œé…é»ç¨®é¡ã€ä¸€æ¨£æ™‚(ä¾‹å¦‚éƒ½æ˜¯é›™é…é»)ï¼Œæ‰æ¯”èª¤å·®
                // é€™è£¡è§£æ±ºäº†æ‚¨çš„éœ€æ±‚ï¼š19é«”63é­”(èª¤å·®å¤§) vs 23é«”59é­”(èª¤å·®å°)ï¼Œèª¤å·®å°çš„æ’å‰é¢
                const errA = getTotalError(a);
                const errB = getTotalError(b);
                if (errA !== errB) return errA - errB;

                // ç¬¬ä¸‰é—œï¼šæ¯”é›†ä¸­åº¦ (å–®é …æ•¸å€¼è¶Šå¤§è¶Šå¥½)
                // åªæœ‰åœ¨é…é»ç¨®é¡ä¸€æ¨£ï¼Œä¸”èª¤å·®ä¹Ÿä¸€æ¨£æ™‚(ä¾‹å¦‚éƒ½æ˜¯èª¤å·®0çš„é›™é…é»)ï¼Œæ‰é¸çœ‹èµ·ä¾†æ¯”è¼ƒæ¼‚äº®çš„
                const sigA = getSignature(a);
                const sigB = getSignature(b);
                for (let i = 0; i < 5; i++) {
                    if (sigB[i] !== sigA[i]) {
                        return sigB[i] - sigA[i]; // å¤§çš„æ’å‰é¢
                    }
                }

                return 0; // å®Œå…¨ä¸€æ¨£
            });

            // === ç¯©é¸æœ€çµ‚çµæœ ===
            // å–å‡ºç¬¬ä¸€åï¼Œä¸¦æŠŠè·Ÿä»–ã€ŒåŒç­‰ç´šã€åŒèª¤å·®ã€åŒç‰¹å¾µã€çš„çµæœéƒ½ç•™ä¸‹ä¾†
            // (é€šå¸¸åªæœƒå‰©ä¸‹éš¨æ©Ÿæª”ä¸åŒï¼Œä½†é…é»é‚è¼¯ä¸€æ¨£çš„ä¸€çµ„è§£)
            const best = sortedResults[0];
            const bestComplexity = getComplexity(best.manualPoints);
            const bestError = getTotalError(best);
            
            // ç‚ºäº†ä¸æ¼æ‰åŒæ¨£å„ªç§€ä½†é…é»ç¨å¾®ä¸åŒçš„ (ä¾‹å¦‚ 23é«”/59é­” å’Œ 24é«”/58é­” éƒ½æ˜¯èª¤å·®0)ï¼Œ
            // æˆ‘å€‘åªåš´æ ¼é™åˆ¶ã€Œé…é»ç¨®é¡ã€å’Œã€Œèª¤å·®ç­‰ç´šã€ã€‚
            // å¦‚æœèª¤å·®ç­‰ç´šä¸€æ¨£å„ªç§€ï¼Œå°±ç®—é…é»ç¨å¾®ä¸åŒä¹Ÿå¯ä»¥é€éåˆ—è¡¨é¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹ã€‚
            
            return sortedResults.filter(row => {
                // 1. å¿…é ˆè·Ÿç¬¬ä¸€åæ˜¯åŒä¸€ç¨®é…é»ç´šåˆ¥ (ä¸èƒ½æ··å…¥ä¸‰é…é»)
                if (getComplexity(row.manualPoints) !== bestComplexity) return false;

                // 2. å¿…é ˆè·Ÿç¬¬ä¸€åæœ‰ä¸€æ¨£å°çš„èª¤å·® (ä¸èƒ½æ··å…¥èª¤å·®å¤§çš„)
                if (getTotalError(row) !== bestError) return false;

                return true;
            });
        }

        function groupByDropAndManual(data) {
            const groups = {};
            data.forEach(item => {
                const key = item.dropCombo.join(',') + '|' + item.manualPoints.join(',');
                if (!groups[key]) groups[key] = [];
                groups[key].push(item);
            });
            return groups;
        }

        function calculateDropStats(data, baseGrow) {
            let totalDropMin = Infinity;
            let totalDropMax = -Infinity;
            const attrDropRanges = Array(5).fill().map(() => ({ min: Infinity, max: -Infinity }));

            data.forEach(item => {
                const totalDrop = item.dropCombo.reduce((sum, d) => sum + d, 0);
                totalDropMin = Math.min(totalDropMin, totalDrop);
                totalDropMax = Math.max(totalDropMax, totalDrop);

                item.dropCombo.forEach((drop, i) => {
                    attrDropRanges[i].min = Math.min(attrDropRanges[i].min, drop);
                    attrDropRanges[i].max = Math.max(attrDropRanges[i].max, drop);
                });
            });

            // çµ±è¨ˆå¿…å®šæ‰æª”èˆ‡ã€Œè‡³å°‘æ‰æª”ã€
            const certainDrops = [];
            attrDropRanges.forEach((range, i) => {
                // æ˜ç¢ºå¿…å®šæ˜¯æŸå€‹å€¼ï¼Œä¸”å¤§æ–¼0
                if (range.min === range.max && range.min > 0) {
                    certainDrops.push(`${ATTR_NAMES[i]}å¿…å®š-${range.min}`);
                } 
                // é›–ç„¶ä¸æ˜¯å®šå€¼ï¼Œä½†æœ€å°å€¼å¤§æ–¼0 (ä¾‹å¦‚ min=3, max=4 => å¿…å®š-3ä»¥ä¸Š)
                else if (range.min > 0) {
                    certainDrops.push(`${ATTR_NAMES[i]}è‡³å°‘-${range.min}`);
                }
            });

            return {
                totalDropRange: { min: totalDropMin, max: totalDropMax },
                certainDrops: certainDrops
            };
        }

        function renderGroupedResults(groupedResults, totalCount) {
            let html = '';
            let groupIndex = 0;
            const sortedGroups = Object.entries(groupedResults).sort((a, b) => b[1].length - a[1].length);

            sortedGroups.forEach(([groupKey, items]) => {
                const percentage = ((items.length / totalCount) * 100).toFixed(2);
                const [dropComboStr, manualPointsStr] = groupKey.split('|');
                const dropCombo = dropComboStr.split(',').map(n => parseInt(n));
                const manualPoints = manualPointsStr.split(',').map(n => parseInt(n));
                const manualPointsText = formatManualPoints(manualPoints);
                
                html += `
                    <div class="result-group">
                        <div class="group-header" onclick="document.dispatchEvent(new CustomEvent('toggle-group', {detail: ${groupIndex}}))">
                            <span class="expand-icon" id="icon-${groupIndex}">â–¶</span>
                            <span class="percentage">${percentage}%</span>
                            <div class="mt-2">
                                <strong>æ‰æª”ï¼š</strong>${dropCombo.map((d, i) => `${ATTR_NAMES[i]}${d}`).join(' ')}
                            </div>
                            <div class="mt-1">
                                <strong>åŠ é»ï¼š</strong>${manualPointsText}
                            </div>
                            <div class="mt-1 text-muted" style="font-size: 0.9em;">
                                <em>é»æ“Šå±•é–‹ ${items.length} å€‹éš¨æ©Ÿæª”çµ„åˆ</em>
                            </div>
                        </div>
                        <div class="random-combos" id="group-${groupIndex}">
                            ${items.map(item => renderRandomCombo(item)).join('')}
                        </div>
                    </div>
                `;
                groupIndex++;
            });
            return html;
        }

        document.addEventListener('toggle-group', (e) => {
            toggleGroup(e.detail);
        });

        function toggleGroup(index) {
            const group = document.getElementById(`group-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            if (group.classList.contains('show')) {
                group.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                group.classList.add('show');
                icon.classList.add('expanded');
            }
        }

        function renderRandomCombo(item) {
            let statusHtml = '';
            
            // ä½¿ç”¨ logic.js å‚³å›çš„ isExact ä¾†åˆ¤æ–·æ˜¯å¦å®Œå…¨ç„¡èª¤å·®
            if (item.isExact) {
                statusHtml = '<span class="badge bg-success ms-2">å®Œå…¨å»åˆ</span>';
            } else {
                // å¦‚æœæœ‰èª¤å·®ï¼Œé¡¯ç¤ºé»ƒè‰²è­¦å‘Š
                const sign = item.sumDiff > 0 ? '+' : '';
                // å¦‚æœ sumDiff ç‚º 0 ä½†ä¸ç²¾ç¢º (ä¾‹å¦‚ HP+1 MP-1)ï¼Œé¡¯ç¤º "èª¤å·®å­˜åœ¨" æˆ–ä¿æŒé¡¯ç¤ºæ•¸å€¼
                const diffText = item.sumDiff === 0 ? 'Â±1' : `${sign}${item.sumDiff}`;
                statusHtml = `<span class="badge bg-warning text-dark ms-2">ç¸½å’Œèª¤å·® ${diffText}</span>`;
            }

            return `
                <div class="combo-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><strong>éš¨æ©Ÿæª”ï¼š</strong>${item.randomCombo.map((r, i) => `${ATTR_NAMES[i]}${r}`).join(' ')}</div>
                        <div>${statusHtml}</div>
                    </div>
                    <div class="mt-1">
                        <span class="stat-badge">HP: ${item.stats.hp.toFixed(2)}</span>
                        <span class="stat-badge">MP: ${item.stats.mp.toFixed(2)}</span>
                        <span class="stat-badge">ATK: ${item.stats.atk.toFixed(2)}</span>
                        <span class="stat-badge">DEF: ${item.stats.def.toFixed(2)}</span>
                        <span class="stat-badge">AGI: ${item.stats.agi.toFixed(2)}</span>
                    </div>
                </div>
            `;
        }

        function formatManualPoints(points) {
            const nonZero = points.map((p,i) => p > 0 ? `${ATTR_NAMES[i]}${p}é»` : null).filter(p => p);
            return nonZero.length > 0 ? nonZero.join('ï¼Œ') : 'ç„¡åŠ é»';
        }
    </script>
</body>
</html>